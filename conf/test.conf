# ════════════════════════════════════════════════════════════════════
# WEBSERV CONFIGURATION FILE - Complete Test Suite
# ════════════════════════════════════════════════════════════════════
# This configuration tests ALL mandatory features from the subject:
# - Multiple servers on different ports
# - GET, POST, DELETE methods
# - Static file serving
# - Directory listing (autoindex)
# - File uploads
# - CGI execution (PHP/Python)
# - HTTP redirections (301/302)
# - Custom error pages
# - client_max_body_size limits
# - Multiple locations per server
# ════════════════════════════════════════════════════════════════════


# ────────────────────────────────────────────────────────────────────
# SERVER 1: Main Website (Port 8080)
# Purpose: General-purpose web server with static content
# ────────────────────────────────────────────────────────────────────
server {
    server_name localhost;
    listen 8080;
    host 0.0.0.0;
    root ./static;
    index index.html;
    client_max_body_size 10M;

	# Custom error pages (MUST work)
	error_page 404 /ErrorPages/404.html;
	error_page 403 /ErrorPages/403.html;
	error_page 500 /ErrorPages/500.html;

    # ┌─────────────────────────────────────────────────────────────┐
    # │ ROOT LOCATION: Basic static file serving with AUTOINDEX		│
    # └─────────────────────────────────────────────────────────────┘
    location / {
        allowed_methods GET POST;
		autoindex on;
        index index.html;
    }
    # Expected behavior:
    # ✓ GET  http://localhost:8080/        → serves index.html
    # ✓ GET  http://localhost:8080/styles.css → serves CSS file
    # ✓ POST http://localhost:8080/        → uploads to ./static/
    # ✗ DELETE (405 Method Not Allowed)

    # ✓ GET http://localhost:8080/ErrorPages/ → HTML directory listing


    # ┌─────────────────────────────────────────────────────────────┐
    # │ HTTP REDIRECTION: 301 Moved Permanently                     │
    # └─────────────────────────────────────────────────────────────┘
    location /google {
        allowed_methods GET;
        return 301 https://www.google.com;
    }
    # Expected behavior:
    # ✓ GET http://localhost:8080/google → HTTP 301 + Location header
    # Browser should automatically redirect to Google

	# ┌─────────────────────────────────────────────────────────────┐
	# │ CUSTOM INDEX FILE: Different index per location             │
	# └─────────────────────────────────────────────────────────────┘
	location /custom {
		allowed_methods GET;
		index samplepage.html;
	}
}


# ────────────────────────────────────────────────────────────────────
# SERVER 2: CGI Testing Server (Port 8081)
# Purpose: Test PHP and Python CGI execution
# ────────────────────────────────────────────────────────────────────
server {
	server_name cgi-test;
	listen 8081;
	host 0.0.0.0;
	root ./static;
	client_max_body_size 5M;

	error_page 404 /ErrorPages/404.html;
	error_page 500 /ErrorPages/500.html;

	location / {
		allowed_methods GET POST;
		index index.html;
	}

	# ┌─────────────────────────────────────────────────────────────┐
	# │ PHP CGI: Execute .php files via php-cgi                     │
	# └─────────────────────────────────────────────────────────────┘
	location /cgi-bin {
		allowed_methods GET POST;
		cgi_extension .php /usr/bin/php-cgi;
	}
	# Expected behavior:
	# ✓ GET  http://localhost:8081/cgi-bin/test.php → executes PHP script
	# Environment variables MUST be set:
	# - REQUEST_METHOD, QUERY_STRING, CONTENT_LENGTH, CONTENT_TYPE
	# - SCRIPT_FILENAME, PATH_INFO, SERVER_PROTOCOL


	# ┌─────────────────────────────────────────────────────────────┐
	# │ PYTHON CGI: Execute .py files via python3                   │
	# └─────────────────────────────────────────────────────────────┘
	location /python {
		allowed_methods GET POST;
		cgi_extension .py /usr/bin/python3;
	}
	# Expected behavior:
	# ✓ GET http://localhost:8081/python/test.py → executes Python script
	# Script MUST output:
	# Content-Type: text/html\r\n\r\n<html>...</html>
}


# ────────────────────────────────────────────────────────────────────
# SERVER 3: File Upload Server (Port 8082)
# Purpose: Test POST file uploads and DELETE operations
# ────────────────────────────────────────────────────────────────────
server {
    server_name upload-server;
    listen 8082;
    host 0.0.0.0;
    root ./static;
    index index.html;
    client_max_body_size 20M;

    error_page 404 /ErrorPages/404.html;
    error_page 405 /ErrorPages/405.html;
    error_page 413 /ErrorPages/413.html;
    error_page 403 /ErrorPages/403.html;
    error_page 500 /ErrorPages/500.html;

    # ┌─────────────────────────────────────────────────────────────┐
    # │ ROOT: Serve index.html with buttons                         │
    # └─────────────────────────────────────────────────────────────┘
    location / {
        allowed_methods GET;
        index index.html;
        autoindex on;
    }
    # Expected behavior:
    # ✓ GET http://localhost:8082/ → serves index.html with buttons

    # ┌─────────────────────────────────────────────────────────────┐
    # │ UPLOADS: POST files, DELETE files, GET directory listing    │
    # └─────────────────────────────────────────────────────────────┘
    location /uploads {
        allowed_methods POST DELETE GET;
        upload_path ./static/uploads;
        root ./static/uploads;
        autoindex on;
    }
    # Expected behavior:
    # ✓ POST   http://localhost:8082/uploads/test.txt   → uploads file
    # ✓ DELETE http://localhost:8082/uploads/test.txt   → removes file
    # ✓ GET    http://localhost:8082/uploads/           → lists files (autoindex)

    # ┌─────────────────────────────────────────────────────────────┐
    # │ ERROR PAGES: Browse error page templates                    │
    # └─────────────────────────────────────────────────────────────┘
    location /ErrorPages {
        allowed_methods GET;
        autoindex on;
    }
    # Expected behavior:
    # ✓ GET http://localhost:8082/ErrorPages/ → lists error pages (autoindex)
}


# ────────────────────────────────────────────────────────────────────
# SERVER 4: Error Testing Server (Port 8083)
# Purpose: Test error handling and edge cases
# ────────────────────────────────────────────────────────────────────
server {
	server_name error-test;
	listen 8083;
	host 0.0.0.0;
	root ./static;
	client_max_body_size 1K;  # Very small limit to trigger 413

	error_page 400 /ErrorPages/400.html;
	error_page 403 /ErrorPages/403.html;
	error_page 404 /ErrorPages/404.html;
	error_page 405 /ErrorPages/405.html;
	error_page 413 /ErrorPages/413.html;
	error_page 500 /ErrorPages/500.html;

	location / {
		allowed_methods GET POST;
		index index.html;
	}

	# ┌─────────────────────────────────────────────────────────────┐
	# │ READ-ONLY LOCATION: Only GET allowed                        │
	# └─────────────────────────────────────────────────────────────┘
	location /readonly {
		allowed_methods GET;
		autoindex off;
	}
	# Expected behavior:
	# ✓ GET  http://localhost:8083/readonly/ErrorPages → 403 Forbidden
	# ✗ POST http://localhost:8083/readonly/ → 405 Method Not Allowed
	# ✗ DELETE → 405 Method Not Allowed
}


# ════════════════════════════════════════════════════════════════════
# TESTING GUIDE
# ════════════════════════════════════════════════════════════════════

# 1. BASIC STATIC FILE SERVING
#    curl http://localhost:8080/
#    curl http://localhost:8080/styles.css

# 2. DIRECTORY LISTING (autoindex)
#    curl http://localhost:8080/ErrorPages

# 3. HTTP REDIRECTIONS
#    curl -I http://localhost:8080/google   # Should show 301

# 4. CGI EXECUTION
#	 curl -X POST -d "name=John&age=30" http://localhost:8081/cgi-bin/test.php
#    curl -X POST -d "name=John" http://localhost:8081/python/test.py

# 5. FILE UPLOAD
#    curl -X POST -F "file=@test.txt" http://localhost:8082/upload

# 6. FILE DELETION
#    curl -X DELETE http://localhost:8082/files/test.txt

# 7. ERROR HANDLING
#    curl http://localhost:8080/nonexistent  # 404
#    curl -X DELETE http://localhost:8080/   # 405
#    curl -X POST --data-binary @largefile http://localhost:8083/tiny  # 413

# 8. STRESS TESTING
#    ab -n 1000 -c 10 http://localhost:8080/
#    siege -c 50 -t 30s http://localhost:8080/

# ════════════════════════════════════════════════════════════════════
# MANDATORY REQUIREMENTS CHECKLIST
# ════════════════════════════════════════════════════════════════════
# ✓ Multiple servers listening on different ports
# ✓ GET, POST, DELETE methods implemented
# ✓ Static file serving (HTML, CSS, images)
# ✓ Directory listing (autoindex on/off)
# ✓ File uploads with custom storage location
# ✓ HTTP redirections (301, 302)
# ✓ Custom error pages
# ✓ client_max_body_size enforcement
# ✓ CGI execution (PHP/Python)
# ✓ Non-blocking I/O with poll()
# ✓ Proper handling of chunked requests
# ✓ Connection timeout management
# ════════════════════════════════════════════════════════════════════

# IMPORTANT NOTES:
# - All servers listen on 0.0.0.0 (all interfaces)
# - Each server has a unique port to avoid binding conflicts
# - Error pages MUST exist in ./static/ErrorPages/
# - CGI interpreters (/usr/bin/php-cgi, /usr/bin/python3) must be installed
# - The server MUST remain non-blocking and never hang
# - poll() is used for ALL I/O operations (sockets, pipes, CGI)
# - Regular file I/O (read/write on disk files) does NOT need poll()